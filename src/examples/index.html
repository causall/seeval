<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>JSONL Evals — Minimal, Dependency‑Free</title>
        <style>
            :root {
                --bg: #0b0c0f; /* deep slate */
                --panel: #14161b;
                --muted: #8b93a7;
                --text: #e9ecf1;
                --accent: #6ee7b7; /* mint */
                --accent-2: #93c5fd; /* blue */
                --danger: #fca5a5;
                --warning: #fde68a;
                --card: #0f1217;
                --border: #21242c;
                --shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
                --radius: 16px;
                --radius-sm: 12px;
                --radius-xs: 10px;
                --pad: 14px;
            }
            * {
                box-sizing: border-box;
            }
            html,
            body {
                height: 100%;
            }
            body {
                margin: 0;
                font:
                    15px/1.5 system-ui,
                    -apple-system,
                    Segoe UI,
                    Roboto,
                    Ubuntu,
                    Cantarell,
                    Noto Sans,
                    Helvetica,
                    Arial,
                    "Apple Color Emoji",
                    "Segoe UI Emoji";
                color: var(--text);
                background:
                    radial-gradient(
                        1200px 800px at 70% -10%,
                        #1a1f2a 0%,
                        var(--bg) 40%
                    ),
                    var(--bg);
            }
            a {
                color: var(--accent-2);
                text-decoration: none;
            }
            header {
                position: sticky;
                top: 0;
                z-index: 10;
                backdrop-filter: blur(10px);
                background: linear-gradient(
                    180deg,
                    rgba(20, 22, 27, 0.85),
                    rgba(20, 22, 27, 0.65)
                );
                border-bottom: 1px solid var(--border);
            }
            .wrap {
                max-width: 1100px;
                margin: 0 auto;
                padding: 18px 18px;
            }
            .row {
                display: flex;
                gap: 14px;
                align-items: center;
                flex-wrap: wrap;
            }
            .spacer {
                flex: 1;
            }

            .btn {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                cursor: pointer;
                border: 1px solid var(--border);
                background: linear-gradient(180deg, #1a1e27, #12151c);
                color: var(--text);
                border-radius: var(--radius-xs);
                padding: 10px 12px;
                box-shadow: var(--shadow);
                transition:
                    transform 0.08s ease,
                    border-color 0.2s ease,
                    box-shadow 0.2s ease,
                    background 0.2s ease;
                user-select: none;
            }
            .btn:hover {
                transform: translateY(-1px);
                border-color: #2a2f3b;
            }
            .btn[disabled] {
                opacity: 0.5;
                cursor: not-allowed;
            }
            .btn.primary {
                border-color: #2a3b33;
                background: linear-gradient(180deg, #1a2a24, #12201b);
            }
            .btn.ghost {
                background: transparent;
                box-shadow: none;
            }
            .btn.danger {
                border-color: #3b2a2a;
                background: linear-gradient(180deg, #2a1a1a, #1c1212);
            }

            .pill {
                padding: 6px 10px;
                border-radius: 999px;
                border: 1px solid var(--border);
                color: var(--muted);
            }
            .badge {
                padding: 4px 8px;
                border-radius: 999px;
                background: #16202a;
                color: var(--accent-2);
                border: 1px solid #243246;
            }

            .grid {
                display: grid;
                gap: 16px;
                grid-template-columns: 1fr 320px;
            }
            @media (max-width: 900px) {
                .grid {
                    grid-template-columns: 1fr;
                }
            }

            .card {
                background: linear-gradient(180deg, #12151c, #0e1116);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                box-shadow: var(--shadow);
            }
            .card .head {
                padding: 12px var(--pad);
                border-bottom: 1px solid var(--border);
                color: var(--muted);
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            .card .body {
                padding: var(--pad);
            }

            .input,
            select,
            textarea {
                width: 100%;
                padding: 10px 12px;
                border-radius: var(--radius-xs);
                border: 1px solid var(--border);
                background: #0c0f14;
                color: var(--text);
            }
            textarea {
                min-height: 110px;
                resize: vertical;
            }

            .kbar {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }
            .k {
                font-family:
                    ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                    "Liberation Mono", monospace;
                padding: 2px 6px;
                border: 1px solid var(--border);
                border-bottom-width: 2px;
                border-radius: 8px;
                color: var(--muted);
            }

            .progress {
                height: 10px;
                background: #0b0f14;
                border-radius: 999px;
                border: 1px solid var(--border);
                position: relative;
                overflow: hidden;
            }
            .progress > span {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 0;
                background: linear-gradient(
                    90deg,
                    var(--accent),
                    var(--accent-2)
                );
                border-radius: inherit;
            }

            .toolbar {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }
            .toolbar .group {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .item-preview {
                font-family:
                    ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                    "Liberation Mono";
                background: #0a0d11;
                border: 1px solid var(--border);
                border-radius: var(--radius);
                padding: 12px;
                overflow: auto;
                min-height: 160px;
                max-height: 60vh;
                resize: vertical;
            }

            .stack {
                display: grid;
                gap: 10px;
            }

            .tabs {
                display: flex;
                gap: 6px;
            }
            .tab {
                padding: 8px 12px;
                border-radius: var(--radius-xs);
                border: 1px solid var(--border);
                background: #0e1117;
                color: var(--muted);
                cursor: pointer;
            }
            .tab.active {
                color: var(--text);
                background: #121722;
            }

            /* Histogram */
            .hist {
                display: grid;
                gap: 6px;
            }
            .bar {
                display: grid;
                grid-template-columns: 80px 1fr auto;
                gap: 8px;
                align-items: center;
            }
            .bar .track {
                height: 12px;
                background: #0b0f14;
                border: 1px solid var(--border);
                border-radius: 999px;
                position: relative;
                overflow: hidden;
            }
            .bar .fill {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 0;
                background: linear-gradient(
                    90deg,
                    var(--accent-2),
                    var(--accent)
                );
                border-radius: 999px;
            }

            .footer {
                color: var(--muted);
                text-align: center;
                padding: 18px;
            }
            .small {
                font-size: 12px;
                color: var(--muted);
            }
            /* Fullscreen overlay for large JSON */
            .overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.55);
                backdrop-filter: blur(6px);
                display: grid;
                place-items: center;
                z-index: 50;
            }
            .overlay[hidden] {
                display: none;
            }
            .overlay .panel {
                width: min(1000px, 92vw);
                height: min(85vh, 92vh);
                background: linear-gradient(180deg, #12151c, #0e1116);
                border: 1px solid var(--border);
                border-radius: var(--radius);
                box-shadow: var(--shadow);
                display: grid;
                grid-template-rows: auto 1fr;
                overflow: hidden;
            }
            .overlay .panel .head {
                border-bottom: 1px solid var(--border);
            }
            .overlay pre {
                margin: 0;
                padding: var(--pad);
                background: #0a0d11;
                overflow: auto;
            }
            .wrap-text {
                white-space: pre-wrap;
                word-break: break-word;
            }
        </style>
    </head>
    <body>
        <header>
            <div class="wrap row">
                <div class="row" style="gap: 10px; align-items: center">
                    <div class="badge">JSONL Evals</div>
                    <span class="small">Fast, minimal, dependency‑free</span>
                </div>
                <div class="spacer"></div>
                <div class="kbar small">
                    <span class="k">J / K</span> next/prev
                    <span class="k">1–9</span> score
                    <span class="k">T / F</span> binary
                    <span class="k">N</span> focus notes
                    <span class="k">⌘/Ctrl + S</span> export
                </div>
            </div>
        </header>

        <main class="wrap grid" id="app" hidden>
            <!-- Left: Evaluate -->
            <section class="stack">
                <div class="card">
                    <div class="head">
                        <div>Dataset</div>
                        <div id="fileMeta" class="small"></div>
                    </div>
                    <div class="body stack">
                        <div class="toolbar">
                            <div class="group">
                                <label class="small">Mode</label>
                                <select id="mode">
                                    <option value="binary">
                                        Binary (True/False)
                                    </option>
                                    <option value="points">
                                        Points (0..Max)
                                    </option>
                                </select>
                            </div>
                            <div class="group" id="maxWrap">
                                <label class="small">Max</label>
                                <input
                                    id="maxScore"
                                    type="number"
                                    class="input"
                                    min="1"
                                    value="5"
                                    style="width: 90px"
                                />
                            </div>
                            <div class="group">
                                <button class="btn ghost" id="prevBtn">
                                    ◀ Prev (K)
                                </button>
                                <button class="btn primary" id="nextBtn">
                                    Next (J) ▶
                                </button>
                            </div>
                            <div class="spacer"></div>
                            <div class="group">
                                <button class="btn" id="exportBtn">
                                    Export JSONL (⌘/Ctrl+S)
                                </button>
                                <button class="btn" id="clearBtn">
                                    Clear Progress
                                </button>
                            </div>
                        </div>

                        <div class="progress">
                            <span id="progressFill"></span>
                        </div>
                        <div
                            class="row"
                            style="align-items: flex-start; gap: 16px"
                        >
                            <div class="card" style="flex: 2">
                                <div class="head">
                                    Item <span id="idxLabel"></span>
                                </div>
                                <div class="body stack">
                                    <div
                                        id="previewTools"
                                        class="toolbar small"
                                    >
                                        <button
                                            class="btn ghost"
                                            id="expandBtn"
                                        >
                                            Expand (Z)
                                        </button>
                                        <button
                                            class="btn ghost"
                                            id="wrapToggle"
                                        >
                                            Wrap
                                        </button>
                                        <button
                                            class="btn ghost"
                                            id="copyBtnSmall"
                                        >
                                            Copy
                                        </button>
                                    </div>
                                    <pre
                                        id="itemPreview"
                                        class="item-preview"
                                    ></pre>
                                    <div id="quickPanel" class="toolbar"></div>
                                    <textarea
                                        id="notes"
                                        class="input"
                                        placeholder="Notes for this item… (N to focus)"
                                    ></textarea>
                                </div>
                            </div>
                            <div class="card" style="flex: 1">
                                <div class="head">Evaluate</div>
                                <div class="body stack" id="evalPanel">
                                    <!-- dynamic controls -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab active" data-tab="stats">
                        Statistics
                    </button>
                    <button class="tab" data-tab="sessions">Sessions</button>
                </div>

                <div id="tab-content">
                    <div class="card" data-view="stats">
                        <div class="head">Overview</div>
                        <div class="body stack" id="stats"></div>
                    </div>

                    <div class="card" data-view="sessions" hidden>
                        <div class="head">Saved Sessions</div>
                        <div class="body stack" id="sessions"></div>
                    </div>
                </div>
            </section>

            <!-- Right: Loader & Config -->
            <aside class="stack">
                <div class="card">
                    <div class="head">Load / Resume</div>
                    <div class="body stack">
                        <input
                            type="file"
                            id="fileInput"
                            class="input"
                            accept=".jsonl,.txt,.json"
                        />
                        <button class="btn" id="loadDemo">Load Demo</button>
                        <div class="small">
                            Local‑only. Progress auto‑saves to your browser
                            storage keyed by a hash of file contents.
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="head">Session</div>
                    <div class="body stack small" id="sessionInfo"></div>
                </div>

                <div class="card">
                    <div class="head">Help</div>
                    <div class="body stack small">
                        <div>
                            • Binary: <em>T</em> = true, <em>F</em> = false
                        </div>
                        <div>
                            • Points: press <em>1…9</em> (or use number input)
                        </div>
                        <div>
                            • Navigation: <em>J</em> next, <em>K</em> prev
                        </div>
                        <div>• Export anytime; file is re‑importable</div>
                    </div>
                </div>
            </aside>
        </main>

        <!-- Fullscreen overlay for large JSON preview -->
        <div id="overlay" class="overlay" hidden>
            <div class="panel">
                <div class="head row">
                    <div>Full Item View</div>
                    <div class="spacer"></div>
                    <button class="btn ghost" id="wrapToggleFull">
                        Wrap (W)
                    </button>
                    <button class="btn ghost" id="copyBtnFull">Copy</button>
                    <button class="btn primary" id="closeOverlay">
                        Close (Esc)
                    </button>
                </div>
                <pre
                    id="overlayPre"
                    class="item-preview"
                    style="height: 100%; max-height: none; resize: none"
                ></pre>
            </div>
        </div>

        <section class="wrap" id="welcome">
            <div class="card" style="max-width: 820px; margin: 30px auto 40px">
                <div class="head">Welcome</div>
                <div class="body stack">
                    <p>
                        Import a <strong>.jsonl</strong> file to begin
                        evaluating. Each line must be a valid JSON object. Your
                        scores and notes are stored locally and can be exported
                        back to JSONL (merging into each object under `seeval: {
                        score, note }`).
                    </p>
                    <div class="row" style="gap: 10px; align-items: center">
                        <input
                            type="file"
                            id="fileInput2"
                            class="input"
                            accept=".jsonl,.txt,.json"
                        />
                        <button class="btn" id="loadDemo2">
                            Try a demo file
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <footer class="footer small">
            Designed to be simple (not complex). No dependencies, runs offline
            in your browser.
        </footer>

        <script>
            // ——— util ———
            const $ = (sel) => document.querySelector(sel);
            const $$ = (sel) => Array.from(document.querySelectorAll(sel));
            const sleep = (ms) => new Promise((r) => setTimeout(r, ms));

            function fmtPct(n) {
                return (n * 100).toFixed(1) + "%";
            }

            async function sha256(text) {
                const enc = new TextEncoder().encode(text);
                const hash = await crypto.subtle.digest("SHA-256", enc);
                return [...new Uint8Array(hash)]
                    .map((b) => b.toString(16).padStart(2, "0"))
                    .join("");
            }

            // Extract the item part for hashing
            async function hashItem(obj) {
                // If object is in canonical format {item: ..., seeval: {...}}, hash only the item
                if (isPlainObject(obj) && "item" in obj) {
                    return await sha256(JSON.stringify(obj.item));
                }
                // Otherwise hash the entire object
                return await sha256(JSON.stringify(obj));
            }

            function download(filename, text) {
                const blob = new Blob([text], {
                    type: "text/plain;charset=utf-8",
                });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.click();
                setTimeout(() => URL.revokeObjectURL(a.href), 1000);
            }

            function jsonlParse(text) {
                const lines = text
                    .split(/\r?\n/)
                    .filter((l) => l.trim().length);
                const out = [];
                const errors = [];
                lines.forEach((l, i) => {
                    try {
                        out.push(JSON.parse(l));
                    } catch (e) {
                        errors.push({
                            line: i + 1,
                            error: "" + e,
                            sample: l.slice(0, 200),
                        });
                    }
                });
                return { items: out, errors, total: lines.length };
            }

            function toJSONL(items) {
                return items.map((o) => JSON.stringify(o)).join("\n");
            }

            function histogram(arr, { mode, max }) {
                const map = new Map();
                if (mode === "binary") {
                    map.set("true", 0);
                    map.set("false", 0);
                }
                arr.forEach((v) => {
                    if (v === null || v === undefined) return;
                    if (mode === "binary")
                        map.set(String(!!v), (map.get(String(!!v)) || 0) + 1);
                    else {
                        const k = Number(v);
                        if (Number.isFinite(k))
                            map.set(k, (map.get(k) || 0) + 1);
                    }
                });
                // Ensure all buckets exist for points
                if (mode === "points") {
                    for (let i = 0; i <= max; i++)
                        if (!map.has(i)) map.set(i, 0);
                }
                return [...map.entries()].sort((a, b) =>
                    ("" + a[0]).localeCompare("" + b[0], undefined, {
                        numeric: true,
                    }),
                );
            }

            function clamp(n, min, max) {
                return Math.max(min, Math.min(max, n));
            }

            function isPlainObject(obj) {
                return (
                    obj !== null &&
                    typeof obj === "object" &&
                    !Array.isArray(obj)
                );
            }

            // ——— preview overlay helpers ———
            let wrapLines = false;
            function currentJSONText() {
                const o = state.items[state.idx] || {};
                // Return just the item content, not wrapped in the canonical format
                return JSON.stringify(o, null, 2);
            }
            function isOverlayOpen() {
                const el = $("#overlay");
                return el && !el.hidden;
            }
            function setOverlayText() {
                const el = $("#overlayPre");
                if (el) el.textContent = currentJSONText();
            }
            function applyWrap() {
                const a = $("#itemPreview");
                const b = $("#overlayPre");
                [a, b].forEach(
                    (x) => x && x.classList.toggle("wrap-text", wrapLines),
                );
            }
            function openOverlay() {
                setOverlayText();
                const el = $("#overlay");
                if (el) {
                    el.hidden = false;
                    applyWrap();
                }
            }
            function closeOverlay() {
                const el = $("#overlay");
                if (el) el.hidden = true;
            }

            // ——— state ———
            const state = {
                rawText: "",
                items: [],
                evals: [], // {score: number|boolean|null, note: string}
                idx: 0,
                mode: "binary",
                max: 5,
                key: null,
                filename: null,
            };

            function storageKey(hash) {
                return `jsonl-evals:${hash}`;
            }

            function save() {
                if (!state.key) return;
                const data = {
                    evals: state.evals,
                    idx: state.idx,
                    mode: state.mode,
                    max: state.max,
                    filename: state.filename,
                };
                localStorage.setItem(state.key, JSON.stringify(data));
                renderSessionInfo();
            }

            function loadIfExists(hash) {
                const key = storageKey(hash);
                const raw = localStorage.getItem(key);
                if (!raw) return null;
                try {
                    return { key, ...JSON.parse(raw) };
                } catch {
                    return null;
                }
            }

            function listSessions() {
                return Object.keys(localStorage)
                    .filter((k) => k.startsWith("jsonl-evals:"))
                    .map((k) => {
                        try {
                            const v = JSON.parse(localStorage.getItem(k));
                            return { key: k, ...v };
                        } catch {
                            return null;
                        }
                    })
                    .filter(Boolean);
            }

            // ——— init / load ———
            async function loadTextAsDataset(text, filename = "dataset.jsonl") {
                // Process items to extract canonical format if present
                const parsed = jsonlParse(text);

                // Process items to handle canonical format {item: ..., seeval: {...}}
                const processedItems = [];
                const processedEvals = [];

                // Create a hash based on the processed items (not the raw text)
                let hashInput = "";

                // Process each item
                for (let i = 0; i < parsed.items.length; i++) {
                    const obj = parsed.items[i];
                    let itemValue,
                        seevalValue = { score: null, note: "" };

                    // Check if item is in canonical format
                    if (isPlainObject(obj) && "item" in obj) {
                        itemValue = obj.item;
                        // Extract seeval if it exists
                        if (obj.seeval) {
                            seevalValue.score = obj.seeval.score ?? null;
                            seevalValue.note = obj.seeval.note ?? "";
                        }
                    } else {
                        // Not in canonical format, use the whole object as the item
                        itemValue = obj;
                    }

                    processedItems.push(itemValue);
                    processedEvals.push(seevalValue);

                    // Add to hash input - only hash the item part
                    hashInput += JSON.stringify(itemValue);
                }

                const hash = await sha256(hashInput);

                state.rawText = text;
                state.items = processedItems;
                state.filename = filename;
                state.evals = processedEvals;
                state.idx = 0;
                state.key = storageKey(hash);

                const existing = loadIfExists(hash);
                if (existing) {
                    state.key = existing.key;
                    state.evals =
                        existing.evals?.length === state.items.length
                            ? existing.evals
                            : state.evals;
                    state.idx = clamp(
                        existing.idx || 0,
                        0,
                        state.items.length - 1,
                    );
                    state.mode = existing.mode || state.mode;
                    state.max = existing.max || state.max;
                }

                $("#mode").value = state.mode;
                $("#maxScore").value = state.max;
                $("#fileMeta").textContent =
                    `${filename} • ${state.items.length} items • ${parsed.errors.length} parse errors`;
                $("#app").hidden = false;
                $("#welcome").hidden = true;
                renderAll();
                save();
                if (parsed.errors.length)
                    (alert(
                        `${parsed.errors.length} line(s) failed to parse. See console for details.`,
                    ),
                        console.warn(parsed.errors));
            }

            async function loadFile(file) {
                const text = await file.text();
                await loadTextAsDataset(text, file.name);
            }

            // ——— rendering ———
            function renderAll() {
                renderItem();
                renderNav();
                renderEvalPanel();
                renderStats();
                renderSessions();
                renderSessionInfo();
            }

            function renderItem() {
                const i = state.idx;
                const o = state.items[i] || {};
                const ev = state.evals[i] || { score: null, note: "" };
                $("#idxLabel").textContent = `${i + 1} / ${state.items.length}`;

                // Display just the item content in the preview
                $("#itemPreview").textContent = JSON.stringify(o, null, 2);
                if (isOverlayOpen()) setOverlayText();

                $("#notes").value = ev.note || "";
                $("#notes").oninput = (e) => {
                    if (!state.evals[i])
                        state.evals[i] = { score: null, note: "" };
                    state.evals[i].note = e.target.value;
                    save();
                };
            }

            function renderNav() {
                const done = state.evals.filter(
                    (e) => e.score !== null && e.score !== undefined,
                ).length;
                const pct = state.items.length ? done / state.items.length : 0;
                $("#progressFill").style.width = pct * 100 + "%";
                $("#nextBtn").disabled = state.idx >= state.items.length - 1;
                $("#prevBtn").disabled = state.idx <= 0;
            }

            function setScore(v) {
                const i = state.idx;
                if (!state.evals[i]) state.evals[i] = { score: null, note: "" };
                if (state.mode === "binary") state.evals[i].score = !!v;
                else
                    state.evals[i].score = clamp(
                        Number(v),
                        0,
                        Number(state.max),
                    );
                renderEvalPanel();
                renderStats();
                renderNav();
                save();
            }

            function renderEvalPanel() {
                const wrap = $("#evalPanel");
                wrap.innerHTML = "";
                const ev = state.evals[state.idx] || { score: null };
                const quick = $("#quickPanel");
                quick.innerHTML = "";

                if (state.mode === "binary") {
                    const t = btn("True", () => setScore(true), "primary");
                    const f = btn("False", () => setScore(false));
                    quick.append(t, f);

                    wrap.append(
                        field(
                            "Current",
                            `<span class="pill">${ev.score === null ? "—" : ev.score ? "True" : "False"}</span>`,
                        ),
                    );
                } else {
                    // Points
                    const max = Number(state.max) || 5;
                    // quick buttons 0..max up to 9 for convenience
                    const maxQuick = Math.min(max, 9);
                    for (let i = 0; i <= maxQuick; i++)
                        quick.append(
                            btn(
                                String(i),
                                () => setScore(i),
                                i === max ? "primary" : "",
                            ),
                        );
                    const input = document.createElement("input");
                    input.type = "number";
                    input.min = 0;
                    input.max = max;
                    input.step = 1;
                    input.className = "input";
                    input.value = ev.score ?? "";
                    input.placeholder = `0..${max}`;
                    input.onchange = () => setScore(Number(input.value));
                    wrap.append(field("Score", input.outerHTML));
                }

                // Notes already rendered under item
            }

            function field(label, html) {
                const div = document.createElement("div");
                div.className = "stack";
                div.innerHTML = `<div class="small" style="color:var(--muted)">${label}</div>${html}`;
                return div;
            }

            function btn(text, onClick, cls = "") {
                const b = document.createElement("button");
                b.className = "btn " + cls;
                b.textContent = text;
                b.onclick = onClick;
                return b;
            }

            function renderStats() {
                const box = $("#stats");
                box.innerHTML = "";
                const N = state.items.length;
                const done = state.evals.filter(
                    (e) => e.score !== null && e.score !== undefined,
                ).length;
                const scores = state.evals.map((e) => e.score);
                let avg = null;
                let acc = null;
                if (state.mode === "binary") {
                    const t = scores.filter((v) => v === true).length;
                    const f = scores.filter((v) => v === false).length;
                    const d = t + f;
                    acc = d ? t / d : null;
                    avg = acc; // for binary, avg == accuracy
                } else {
                    const nums = scores
                        .map((v) => (Number.isFinite(v) ? Number(v) : null))
                        .filter((v) => v !== null);
                    const sum = nums.reduce((a, b) => a + b, 0);
                    avg = nums.length ? sum / nums.length : null;
                }
                const H = histogram(scores, {
                    mode: state.mode,
                    max: Number(state.max) || 5,
                });

                const meta = document.createElement("div");
                meta.className = "row";
                meta.innerHTML = `
        <div class="pill">Items: <strong>${N}</strong></div>
        <div class="pill">Completed: <strong>${done}</strong> (${fmtPct(N ? done / N : 0)})</div>
        <div class="pill">Mode: <strong>${state.mode}</strong></div>
        ${state.mode === "points" ? `<div class="pill">Max: <strong>${state.max}</strong></div>` : ""}
        <div class="pill">Average: <strong>${avg === null ? "—" : state.mode === "points" ? avg.toFixed(2) : fmtPct(avg)}</strong></div>
      `;
                box.append(meta);

                // Histogram
                const hist = document.createElement("div");
                hist.className = "hist";
                H.forEach(([k, v]) => {
                    const pct = done ? v / done : 0;
                    const row = document.createElement("div");
                    row.className = "bar";
                    const label = document.createElement("div");
                    label.className = "small";
                    label.textContent = String(k);
                    const track = document.createElement("div");
                    track.className = "track";
                    const fill = document.createElement("div");
                    fill.className = "fill";
                    fill.style.width = pct * 100 + "%";
                    track.append(fill);
                    const count = document.createElement("div");
                    count.className = "small";
                    count.textContent = `${v} (${fmtPct(pct)})`;
                    row.append(label, track, count);
                    hist.append(row);
                });
                const card = document.createElement("div");
                card.append(hist);
                box.append(card);
            }

            function renderSessions() {
                const box = $("#sessions");
                box.innerHTML = "";
                const sessions = listSessions();
                if (!sessions.length) {
                    box.innerHTML =
                        '<div class="small">No saved sessions.</div>';
                    return;
                }
                sessions.forEach((s) => {
                    const div = document.createElement("div");
                    div.className = "row";
                    const title = document.createElement("div");
                    title.className = "pill";
                    title.textContent = `${s.filename || "dataset"} — ${s.evals?.length || 0} items, mode ${s.mode || ""}`;
                    const loadBtn = btn("Load", async () => {
                        // We cannot recover original text from storage; ask user to re-open original file.
                        alert(
                            "To resume, re-open the original file. Progress will auto-restore based on content hash.",
                        );
                    });
                    const delBtn = btn(
                        "Delete",
                        () => {
                            localStorage.removeItem(s.key);
                            renderSessions();
                        },
                        "danger",
                    );
                    div.append(title, loadBtn, delBtn);
                    box.append(div);
                });
            }

            function renderSessionInfo() {
                const box = $("#sessionInfo");
                if (!state.key) {
                    box.innerHTML =
                        '<div class="small">No active session.</div>';
                    return;
                }
                const s = {
                    idx: state.idx + 1,
                    total: state.items.length,
                    mode: state.mode,
                    max: state.max,
                    key: state.key,
                    filename: state.filename,
                };
                box.innerHTML = `
        <div><strong>File:</strong> ${s.filename}</div>
        <div><strong>Index:</strong> ${s.idx} / ${s.total}</div>
        <div><strong>Mode:</strong> ${s.mode}${s.mode === "points" ? ` (max ${s.max})` : ""}</div>
        <div class="small" style="word-break:break-all"><strong>Key:</strong> ${s.key}</div>
      `;
            }

            // ——— actions ———
            function next() {
                state.idx = clamp(state.idx + 1, 0, state.items.length - 1);
                renderAll();
                save();
            }
            function prev() {
                state.idx = clamp(state.idx - 1, 0, state.items.length - 1);
                renderAll();
                save();
            }

            async function exportJSONL() {
                // Always export using the canonical format: { item, seeval }
                const merged = state.items.map((o, i) => {
                    const e = state.evals[i] || {};
                    // Only include seeval if there's a score or note
                    const hasEvals =
                        e.score !== null || (e.note && e.note.trim() !== "");
                    const result = { item: o };

                    if (hasEvals) {
                        result.seeval = {
                            score: e.score ?? null,
                            note: e.note ?? "",
                        };
                    }

                    return result;
                });
                const text = toJSONL(merged);
                const base =
                    state.filename?.replace(/\.[^/.]+$/, "") || "dataset";
                download(`${base}.annotated.jsonl`, text);
            }

            function clearProgress() {
                if (!state.key) return;
                if (!confirm("Delete saved progress for this file?")) return;
                localStorage.removeItem(state.key);
                alert("Progress cleared.");
                // keep current in-memory so the user can continue if they want
                renderSessions();
            }

            // ——— events ———
            $("#fileInput").addEventListener("change", (e) => {
                const f = e.target.files[0];
                if (f) loadFile(f);
            });
            $("#fileInput2").addEventListener("change", (e) => {
                const f = e.target.files[0];
                if (f) loadFile(f);
            });

            $("#mode").addEventListener("change", (e) => {
                state.mode = e.target.value;
                $("#maxWrap").style.display =
                    state.mode === "points" ? "flex" : "none";
                renderEvalPanel();
                renderStats();
                save();
            });
            $("#maxScore").addEventListener("change", (e) => {
                state.max = Math.max(1, Number(e.target.value) || 5);
                renderEvalPanel();
                renderStats();
                save();
            });

            $("#nextBtn").onclick = next;
            $("#prevBtn").onclick = prev;
            $("#exportBtn").onclick = exportJSONL;
            $("#clearBtn").onclick = clearProgress;

            // Preview tool buttons
            const expandBtn = document.getElementById("expandBtn");
            const wrapSmall = document.getElementById("wrapToggle");
            const copySmall = document.getElementById("copyBtnSmall");
            if (expandBtn) expandBtn.onclick = openOverlay;
            if (wrapSmall)
                wrapSmall.onclick = () => {
                    wrapLines = !wrapLines;
                    applyWrap();
                };
            if (copySmall)
                copySmall.onclick = () => {
                    try {
                        navigator.clipboard &&
                            navigator.clipboard.writeText(currentJSONText());
                    } catch (e) {}
                };

            // Overlay controls
            const closeOv = document.getElementById("closeOverlay");
            const wrapFull = document.getElementById("wrapToggleFull");
            const copyFull = document.getElementById("copyBtnFull");
            const overlay = document.getElementById("overlay");
            if (closeOv) closeOv.onclick = closeOverlay;
            if (wrapFull)
                wrapFull.onclick = () => {
                    wrapLines = !wrapLines;
                    applyWrap();
                };
            if (copyFull)
                copyFull.onclick = () => {
                    try {
                        navigator.clipboard &&
                            navigator.clipboard.writeText(currentJSONText());
                    } catch (e) {}
                };
            if (overlay)
                overlay.addEventListener("click", (e) => {
                    if (e.target === overlay) closeOverlay();
                });

            // Tabs
            $$(".tab").forEach(
                (t) =>
                    (t.onclick = () => {
                        $$(".tab").forEach((x) => x.classList.remove("active"));
                        t.classList.add("active");
                        const v = t.dataset.tab;
                        $$("[data-view]").forEach(
                            (x) => (x.hidden = x.dataset.view !== v),
                        );
                    }),
            );

            // Keyboard shortcuts
            document.addEventListener("keydown", (e) => {
                if (e.target.matches("input,textarea")) {
                    if (
                        (e.key === "s" || e.key === "S") &&
                        (e.metaKey || e.ctrlKey)
                    ) {
                        e.preventDefault();
                        exportJSONL();
                    }
                    return;
                }

                const ovOpen = isOverlayOpen();
                if (ovOpen) {
                    if (e.key === "Escape") {
                        e.preventDefault();
                        closeOverlay();
                        return;
                    }
                    if (e.key === "w" || e.key === "W") {
                        e.preventDefault();
                        wrapLines = !wrapLines;
                        applyWrap();
                        return;
                    }
                }
                if (e.key === "z" || e.key === "Z") {
                    e.preventDefault();
                    openOverlay();
                    return;
                }

                if (e.key === "j" || e.key === "J" || e.key === "ArrowRight") {
                    e.preventDefault();
                    next();
                }
                if (e.key === "k" || e.key === "K" || e.key === "ArrowLeft") {
                    e.preventDefault();
                    prev();
                }
                if (e.key === "n" || e.key === "N") {
                    e.preventDefault();
                    $("#notes").focus();
                }
                if (state.mode === "binary") {
                    if (e.key === "t" || e.key === "T") {
                        setScore(true);
                    }
                    if (e.key === "f" || e.key === "F") {
                        setScore(false);
                    }
                } else {
                    const d = e.key.charCodeAt(0) - "0".charCodeAt(0);
                    if (d >= 0 && d <= 9) {
                        setScore(d);
                    }
                }
                if (
                    (e.key === "s" || e.key === "S") &&
                    (e.metaKey || e.ctrlKey)
                ) {
                    e.preventDefault();
                    exportJSONL();
                }
            });

            // Demo data
            const demo = [
                { id: 1, question: "2+2?", answer: "4" },
                { id: 2, question: "Capital of France?", answer: "Paris" },
                { id: 3, question: "Is water wet?", answer: "Yes" },
            ]
                .map(JSON.stringify)
                .join("\n");
            $("#loadDemo").onclick = () =>
                loadTextAsDataset(demo, "demo.jsonl");
            $("#loadDemo2").onclick = () =>
                loadTextAsDataset(demo, "demo.jsonl");

            // Initial UI state
            $("#maxWrap").style.display = "none";
            $("#app").hidden = true;
        </script>
    </body>
</html>
