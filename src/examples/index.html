<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Evaluation Interface</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f9fafb;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        background: white;
        padding: 16px 24px;
        border-radius: 12px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h2 {
        margin: 0;
        font-size: 20px;
      }

      .progress {
        font-size: 14px;
        color: #6b7280;
      }

      .main-layout {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
      }

      .left-column {
        flex: 1 1 60%;
      }

      .right-column {
        flex: 1 1 40%;
      }

      .card {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin-bottom: 16px;
      }

      .card h3 {
        margin: 0 0 12px 0;
        font-size: 16px;
        color: #111827;
      }

      .view-section {
        margin-bottom: 16px;
      }

      .view-label {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 4px;
        font-family: monospace;
      }

      .view-content {
        background: #f9fafb;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
      }

      .scroll {
        max-height: 300px;
        overflow: auto;
      }

      .data-section {
        background: #fef3c7;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #fcd34d;
      }

      .rubric-desc {
        font-size: 14px;
        margin-bottom: 8px;
      }

      .rubric-scale {
        font-size: 13px;
        margin-bottom: 4px;
        font-style: italic;
      }

      .rubric-range {
        font-size: 12px;
        margin-bottom: 16px;
      }

      .muted {
        color: #6b7280;
        font-size: 12px;
      }

      .score-buttons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .score-btn {
        min-width: 48px;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.2s;
      }

      .score-btn:hover {
        border-color: #3b82f6;
        background: #eff6ff;
      }

      .score-btn.active {
        border-color: #3b82f6;
        background: #3b82f6;
        color: white;
      }

      .score-input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 16px;
      }

      .nav-controls {
        display: flex;
        justify-content: space-between;
        gap: 12px;
      }

      button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: #2563eb;
      }

      .btn-secondary {
        background: #e5e7eb;
        color: #374151;
      }

      .btn-secondary:hover:not(:disabled) {
        background: #d1d5db;
      }

      .file-loader {
        background: white;
        padding: 40px 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .file-loader h2 {
        margin: 0 0 12px 0;
      }

      #app {
        display: none;
      }

      #app.loaded {
        display: block;
      }

      pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="file-loader" id="file-loader">
        <h2>Load Evaluation Dataset</h2>
        <p class="muted">Select a .jsonl file containing evaluation data</p>
        <input
          type="file"
          id="file-input"
          accept=".jsonl,.json"
          style="margin: 16px 0"
        />
      </div>

      <div id="app">
        <div class="header">
          <h2>Evaluation Task</h2>
          <div class="progress" id="progress"></div>
        </div>

        <div class="main-layout">
          <div class="left-column" id="left-column"></div>
          <div class="right-column" id="right-column"></div>
        </div>

        <div class="nav-controls">
          <div
            style="
              display: flex;
              justify-content: space-between;
              margin-bottom: 8px;
            "
          >
            <button id="prev-item-btn" class="btn-secondary">
              ← Previous Item
            </button>
            <button id="next-item-btn" class="btn-secondary">
              Next Item →
            </button>
          </div>
          <div style="display: flex; justify-content: space-between; gap: 12px">
            <button id="prev-group-btn" class="btn-secondary">
              ← Prev Group
            </button>
            <button id="submit-btn" class="btn-primary">
              Submit & Next Group →
            </button>
            <button id="next-group-btn" class="btn-secondary">
              Next Group →
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { JSONPath } from "https://cdn.jsdelivr.net/npm/jsonpath-plus@7.2.0/+esm";
      window.JSONPath = JSONPath;
    </script>
    <script src="evaluator.js"></script>
    <script>
      let state = null;
      let dataHash = null;

      // File loading
      document.getElementById("file-input").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const content = event.target.result;
            const jsonlEntries = parseJSONL(content);

            if (jsonlEntries.length === 0) {
              alert("No valid JSONL entries found in file");
              return;
            }

            // Generate hash for state persistence
            dataHash = generateHash(content);

            // Initialize state
            state = new EvaluationState(jsonlEntries);

            // Try to restore previous state
            const savedState = loadState(dataHash);
            if (savedState && confirm("Resume previous session?")) {
              state.currentEntryIndex = savedState.currentEntryIndex || 0;
              state.currentDatumIndex = savedState.currentDatumIndex;
              state.currentItemIndex = savedState.currentItemIndex;
              state.scores = savedState.scores;
              state.groupItemPositions = savedState.groupItemPositions || {};
            }

            // Show app, hide loader
            document.getElementById("file-loader").style.display = "none";
            document.getElementById("app").classList.add("loaded");

            render();
          } catch (error) {
            alert("Error loading file: " + error.message);
          }
        };
        reader.readAsText(file);
      });

      // Rendering
      function render() {
        if (!state) return;

        const datum = state.getCurrentDatum();
        const item = state.getCurrentItem();
        const score = state.getCurrentScore();
        const progress = state.getProgress();

        // Update progress
        document.getElementById(
          "progress"
        ).textContent = `Entry ${progress.entryIndex}/${progress.entryTotal} | Group ${progress.groupIndex}/${progress.groupTotal} | Item ${progress.itemIndex}/${progress.itemTotal}`;

        // Render columns
        document.getElementById("left-column").innerHTML = renderLeftColumn(
          item,
          state.rawData
        );
        document.getElementById("right-column").innerHTML = renderRightColumn(
          datum,
          score
        );

        // Attach score button listeners
        document.querySelectorAll(".score-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const score = parseFloat(btn.dataset.score);
            state.setScore(score);
            saveState(state, dataHash);
            render();
          });
        });

        // Attach score input listener
        const scoreInput = document.getElementById("score-input");
        if (scoreInput) {
          scoreInput.addEventListener("input", (e) => {
            const score = parseFloat(e.target.value);
            if (!isNaN(score)) {
              state.setScore(score);
              saveState(state, dataHash);
            }
          });
        }

        // Update navigation buttons
        document.getElementById("prev-item-btn").disabled = !state.canGoPrev();
        document.getElementById("next-item-btn").disabled = !state.canGoNext();
        document.getElementById("prev-group-btn").disabled =
          !state.canGoPrevGroup();
        document.getElementById("next-group-btn").disabled =
          !state.canGoNextGroup();
        document.getElementById("submit-btn").disabled =
          !state.canSubmitGroup();
        document.getElementById("submit-btn").textContent =
          progress.groupIndex < progress.groupTotal
            ? "Submit & Next Group →"
            : "Complete Evaluation";
      }

      // Navigation
      document.getElementById("prev-item-btn").addEventListener("click", () => {
        if (state.canGoPrev()) {
          state.prevItem();
          saveState(state, dataHash);
          render();
        }
      });

      document.getElementById("next-item-btn").addEventListener("click", () => {
        if (state.canGoNext()) {
          state.nextItem();
          saveState(state, dataHash);
          render();
        }
      });

      document
        .getElementById("prev-group-btn")
        .addEventListener("click", () => {
          if (
            !state.isGroupComplete() &&
            !confirm("Current group is incomplete. Continue anyway?")
          ) {
            return;
          }

          if (state.prevGroup()) {
            saveState(state, dataHash);
            render();
          }
        });

      document
        .getElementById("next-group-btn")
        .addEventListener("click", () => {
          if (
            !state.isGroupComplete() &&
            !confirm("Current group is incomplete. Continue anyway?")
          ) {
            return;
          }

          if (state.jumpToNextGroup()) {
            saveState(state, dataHash);
            render();
          }
        });

      document.getElementById("submit-btn").addEventListener("click", () => {
        if (!state.canSubmitGroup()) {
          alert("Please score all items before submitting");
          return;
        }

        if (state.nextGroup()) {
          saveState(state, dataHash);
          render();
        } else {
          // All done!
          exportResults();
        }
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (!state) return;

        const datum = state.getCurrentDatum();
        const range = datum.rubric.le - datum.rubric.ge;

        // Number keys for scoring (if using buttons)
        if (range <= 9 && e.key >= "0" && e.key <= "9") {
          const score = parseInt(e.key);
          if (score >= datum.rubric.ge && score <= datum.rubric.le) {
            state.setScore(score);
            saveState(state, dataHash);
            render();
          }
        }

        // Arrow keys for navigation
        if (e.key === "ArrowLeft") {
          if (e.ctrlKey || e.metaKey) {
            // Ctrl+Left for previous group
            if (state.canGoPrevGroup()) {
              if (
                !state.isGroupComplete() &&
                !confirm("Current group is incomplete. Continue anyway?")
              ) {
                return;
              }
              state.prevGroup();
              saveState(state, dataHash);
              render();
            }
          } else if (state.canGoPrev()) {
            // Left for previous item
            state.prevItem();
            saveState(state, dataHash);
            render();
          }
        }

        if (e.key === "ArrowRight") {
          if (e.ctrlKey || e.metaKey) {
            // Ctrl+Right for next group
            if (state.canGoNextGroup()) {
              if (
                !state.isGroupComplete() &&
                !confirm("Current group is incomplete. Continue anyway?")
              ) {
                return;
              }
              state.jumpToNextGroup();
              saveState(state, dataHash);
              render();
            }
          } else if (state.canGoNext()) {
            // Right for next item
            state.nextItem();
            saveState(state, dataHash);
            render();
          }
        }

        // Enter to advance (if current item scored)
        if (e.key === "Enter" && state.getCurrentScore() !== null) {
          if (state.canGoNext()) {
            state.nextItem();
          } else if (state.canSubmitGroup()) {
            document.getElementById("submit-btn").click();
          }
          saveState(state, dataHash);
          render();
        }

        // Escape to clear score
        if (e.key === "Escape") {
          state.scores[state.getScoreKey()] = null;
          saveState(state, dataHash);
          render();
        }
      });

      // Export results
      function exportResults() {
        const jsonlOutput = exportResultsAsJSONL(
          state.jsonlEntries,
          state.scores
        );

        const blob = new Blob([jsonlOutput], {
          type: "application/x-jsonlines",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "evaluation_results.jsonl";
        a.click();

        alert("Evaluation complete! Results downloaded.");
        clearState(dataHash);
      }
    </script>
  </body>
</html>
